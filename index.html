<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
  --bg: #0f172a;
  --panel: #020617;
  --me: #2563eb;
  --other: #1e293b;
  --accent: #38bdf8;
}

body {
  margin: 0;
  height: 100vh;
  display: flex;
  background: var(--bg);
  color: #e5e7eb;
  font-family: system-ui, sans-serif;
}

/* Sidebar */
#users {
  width: 240px;
  background: var(--panel);
  padding: 10px;
  overflow-y: auto;
}
.user {
  padding: 8px;
  border-bottom: 1px solid #1e293b;
}
.online { color: #22c55e; }
.offline { opacity: .6; font-size: 12px; }

/* Chat area */
#chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}
#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}
.msg {
  max-width: 70%;
  padding: 8px 10px;
  margin-bottom: 8px;
  border-radius: 10px;
}
.me {
  background: var(--me);
  margin-left: auto;
}
.other {
  background: var(--other);
}
.name {
  font-size: 11px;
  color: var(--accent);
}
.time {
  font-size: 10px;
  opacity: .7;
  text-align: right;
}

/* Typing */
#typing {
  font-size: 12px;
  padding: 4px 10px;
  opacity: .7;
}

/* Input */
#inputBox {
  display: flex;
  padding: 10px;
  background: var(--panel);
}
input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: none;
  font-size: 15px;
}
button {
  margin-left: 8px;
  padding: 10px 16px;
  border-radius: 20px;
  border: none;
  background: var(--accent);
  cursor: pointer;
}

/* Mobile */
@media (max-width: 768px) {
  #users { display: none; }
  .msg { max-width: 85%; }
}
</style>
</head>

<body>

<div id="users"></div>

<div id="chat">
  <div id="messages"></div>
  <div id="typing"></div>
  <div id="inputBox">
    <input id="text" placeholder="Message…" oninput="setTyping(true)">
    <button onclick="send()">Send</button>
  </div>
</div>

<audio id="sound" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAFm0Ii_iaoZdjnodm0AdW-Lq3IncFR0w8",
  authDomain: "chat-39462.firebaseapp.com",
  databaseURL: "https://chat-39462-default-rtdb.firebaseio.com",
  projectId: "chat-39462",
  appId: "1:817402839672:web:22a4b860409efa6708638d"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const messagesRef = db.ref("messages");
const usersRef = db.ref("users");
const typingRef = db.ref("typing");

let name = localStorage.getItem("name");
if (!name) {
  name = prompt("Your name?") || "Anonymous";
  localStorage.setItem("name", name);
}

/* Presence */
const meRef = usersRef.child(name);
meRef.set({ online: true, last: Date.now() });
meRef.onDisconnect().set({ online: false, last: Date.now() });

/* Users list */
usersRef.on("value", snap => {
  users.innerHTML = "";
  snap.forEach(u => {
    const d = u.val();
    users.innerHTML += `
      <div class="user">
        <div class="${d.online ? 'online':'offline'}">${u.key}</div>
        ${!d.online ? `<div class="offline">last seen ${format(d.last)}</div>` : ""}
      </div>`;
  });
});

/* Messages */
let first = true;
messagesRef.limitToLast(100).on("child_added", s => {
  const m = s.val();
  const div = document.createElement("div");
  div.className = `msg ${m.name === name ? "me":"other"}`;
  div.innerHTML = `
    <div class="name">${m.name}</div>
    <div>${m.text}</div>
    <div class="time">${format(m.time)}</div>`;
  messages.appendChild(div);
  messages.scrollTop = 999999;
  if (!first && m.name !== name) sound.play();
  first = false;
});

/* Typing */
let typingTimeout;
function setTyping(v) {
  typingRef.child(name).set(v);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>typingRef.child(name).remove(),1000);
}
typingRef.on("value", s => {
  let t = [];
  s.forEach(x => x.key !== name && t.push(x.key));
  typing.innerText = t.length ? `${t.join(", ")} typing…` : "";
});

/* Send */
function send() {
  if (!text.value.trim()) return;
  messagesRef.push({ name, text: text.value, time: Date.now() });
  text.value = "";
  setTyping(false);
}

function format(t){
  return new Date(t).toLocaleString("en-IN",{timeZone:"Asia/Kolkata",hour:"2-digit",minute:"2-digit"});
}
</script>
</body>
</html>
